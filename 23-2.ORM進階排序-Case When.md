## Case å’Œ When æ˜¯ä»€éº¼?
åœ¨ Django ORM ä¸­ï¼ŒCase å’Œ When æ˜¯ç”¨ä¾†é€²è¡Œæ¢ä»¶å¼æŸ¥è©¢èˆ‡è³‡æ–™æ’åºçš„é‡è¦å·¥å…·ã€‚ç•¶ä½ éœ€è¦æ ¹æ“šä¸åŒçš„æ¢ä»¶çµ¦æ¬„ä½æŒ‡å®šä¸åŒçš„å€¼ï¼Œæˆ–å¯¦ä½œè‡ªå®šç¾©æ’åºé‚è¼¯æ™‚ï¼Œéå¸¸æœ‰ç”¨ã€‚


## åŸºæœ¬èªæ³•:
```py
from django.db.models import Case, When, Value, IntegerField

Case(
    When(æ¢ä»¶æˆç«‹æ™‚, then=Value(çµ¦å®šå€¼)),
    # å¯ä»¥æœ‰å¤šå€‹ When
    default=Value(é è¨­å€¼),  # æ‰€æœ‰æ¢ä»¶éƒ½ä¸æˆç«‹æ™‚çš„é è¨­å€¼
    output_field=è¼¸å‡ºæ¬„ä½é¡å‹Field()
)

ğŸ§© ç¯„ä¾‹

    Case(
        When(status='paid', then=Value('å·²ä»˜æ¬¾')),
        When(status='pending', then=Value('å¾…ä»˜æ¬¾')),
        default=Value('æœªçŸ¥ç‹€æ…‹'),
        output_field=CharField()
    )
```
ğŸ§© **èªªæ˜ï¼š**
- `When(...)`ï¼šæŒ‡å®šæ¢ä»¶ï¼Œæ¢ä»¶æˆç«‹æ™‚çš„å›å‚³å€¼æ”¾åœ¨ then=...
- `default=...`ï¼šæ‰€æœ‰æ¢ä»¶éƒ½ä¸ç¬¦åˆæ™‚ä½¿ç”¨çš„é è¨­å€¼
- `output_field=...`ï¼šå¿…å¡«ï¼ŒæŒ‡å®šå›å‚³å€¼çš„é¡å‹ï¼Œä¾‹å¦‚ï¼š
    - `IntegerField()`ï¼šæ•´æ•¸
    - `CharField()`ï¼šå­—ä¸²
    - `BooleanField()`ï¼šå¸ƒæ—å€¼



---

## ç¯„ä¾‹ä¸€: çµåˆ`annotate()`æ–°å¢ä¸€å€‹è™›æ“¬æ¬„ä½ï¼Œæ ¹æ“šä½¿ç”¨è€…æ˜¯å¦ç‚ºç®¡ç†å“¡ä¾†æŒ‡å®šæ¬Šé‡å€¼
```py
from django.db.models import Case, When, Value, IntegerField
from myapp.models import User

queryset = User.objects.annotate(
    priority=Case(
        When(is_superuser=True, then=Value(1)),
        When(is_staff=True, then=Value(2)),
        default=Value(3),
        output_field=IntegerField()
    )
)
```
- æ­¤æ®µç¨‹å¼ç¢¼æœƒå¹«æ¯å€‹ User æ–°å¢ä¸€å€‹ priority æ¬„ä½ï¼Œå…¶å€¼å¦‚ä¸‹ï¼š
 - æ˜¯ superuser âœ 1
 - æ˜¯ staff âœ 2
 - å…¶ä»– âœ 3

---

## ğŸ¯ çµåˆ .order_by() è‡ªå®šç¾©æ’åº
```py
queryset = User.objects.annotate(
    priority=Case(
        When(status='vip', then=Value(1)),
        When(status='member', then=Value(2)),
        default=Value(3),
        output_field=IntegerField()
    )
).order_by('priority')
```
- é€™æ¨£å¯ä»¥ä¾ç…§ status æ¬„ä½ä¸­çš„ç­‰ç´šï¼ˆä¾‹å¦‚ VIP æ’åœ¨æœ€å‰ï¼‰é€²è¡Œæ’åºã€‚

---

## ğŸ”„ æ­é… update() â†’ æ‰¹æ¬¡æ¢ä»¶æ›´æ–°
```py
from django.db.models import Case, When, Value, IntegerField
from myapp.models import User

User.objects.update(
    priority=Case(
        When(role='admin', then=Value(10)),
        When(role='editor', then=Value(5)),
        default=Value(1),
        output_field=IntegerField()
    )
)
```
- é€™æ®µç¨‹å¼ç¢¼æœƒç›´æ¥æ›´æ–°è³‡æ–™åº«ä¸­çš„ priority æ¬„ä½ï¼š
    - role ç‚º 'admin' çš„ â†’ priority = 10
    - role ç‚º 'editor' çš„ â†’ priority = 5
    - å…¶ä»–å‰‡è¨­ç‚º 1


---
## ğŸ“¦ å¤šå€‹æ¬„ä½æ¢ä»¶
å¯ä»¥ä½¿ç”¨å¤šå€‹æ¢ä»¶çµ„åˆä¾†è¨­å®š Whenï¼š
```py
Case(
    When(type='A', status='active', then=Value('æœ‰æ•ˆA')),
    When(type='B', status='active', then=Value('æœ‰æ•ˆB')),
    default=Value('ç„¡æ•ˆ'),
    output_field=models.CharField()
)
```
---
## ğŸ§© ä½¿ç”¨ F()è¡¨é”å¼ æ­é… Case / When
å‡è¨­æœ‰ä¸€å€‹å•†å“æ¨¡å‹ Productï¼Œå…¶ä¸­æœ‰æ¬„ä½ stockï¼ˆåº«å­˜é‡ï¼‰å’Œ soldï¼ˆå·²å”®å‡ºæ•¸é‡ï¼‰ï¼Œæƒ³ä¾æ“šé€™å…©å€‹æ¬„ä½ä¾†æ¨™è¨˜åº«å­˜ç‹€æ…‹ã€‚
```py
from django.db.models import F, Case, When, Value, CharField

Product.objects.annotate(
    stock_status=Case(
        When(stock__lte=F('sold'), then=Value('å”®ç½„')),
        When(stock__gt=F('sold'), then=Value('å°šæœ‰åº«å­˜')),
        default=Value('æœªçŸ¥'),
        output_field=CharField()
    )
)
```
âœ… èªªæ˜ï¼š

- `F('sold')` è¡¨ç¤ºã€Œä½¿ç”¨ç•¶å‰è³‡æ–™è¡Œçš„ sold æ¬„ä½å€¼ä¾†ä½œç‚ºæ¯”è¼ƒä¾æ“šã€ã€‚

- `stock__lte=F('sold')` âœ ç•¶åº«å­˜å°æ–¼æˆ–ç­‰æ–¼éŠ·å”®é‡æ™‚ï¼Œæ¨™è¨˜ç‚ºã€Œå”®ç½„ã€ã€‚

- `stock__gt=F('sold')` âœ è¡¨ç¤ºé‚„æœ‰åº«å­˜ã€‚
- åŠ ä¸Š `output_field=CharField()` æ˜¯å¿…é ˆçš„ï¼ŒæŒ‡å®šé€™æ˜¯ç”¢ç”Ÿçš„æ–‡å­—æ¬„ä½ã€‚

---
## ğŸ§  è£œå……ï¼šæ­é… F() åšæ‰¹æ¬¡æ›´æ–°
ä¹Ÿå¯ä»¥æ­é… F() + Case() åœ¨ update() ä¸­å‹•æ…‹æ›´æ–°æ¬„ä½ï¼š

```python
from django.db.models import F, Case, When, Value, IntegerField

Product.objects.update(
    stock_status=Case(
        When(stock__lte=F('sold'), then=Value(0)),  # 0 ä»£è¡¨å”®ç½„
        When(stock__gt=F('sold'), then=Value(1)),   # 1 ä»£è¡¨å°šæœ‰åº«å­˜
        default=Value(2),
        output_field=IntegerField()
    )
)

```
âœ… èªªæ˜ï¼š
- `When(stock__lte=F('sold'), then=Value(0))`
    - è‹¥åº«å­˜é‡å°æ–¼æˆ–ç­‰æ–¼å·²å”®å‡ºé‡ï¼ˆ= å”®ç½„ï¼‰ï¼Œå°‡ `stock_status`æ¬„ä½ è¨­ç‚º 0ã€‚
<br>
- `When(stock__gt=F('sold'), then=Value(1))`
    - è‹¥åº«å­˜é‡å¤§æ–¼å·²å”®å‡ºé‡ï¼Œè¡¨ç¤ºå°šæœ‰åº«å­˜ï¼Œè¨­ç‚º 1ã€‚

---

## ğŸ§  èˆ‡ DRF Serializer çµåˆ
è‹¥è¦åœ¨ API å›å‚³ä¸­çœ‹åˆ° Case æ‰€ç”¢ç”Ÿçš„æ¬„ä½ï¼Œå¯ä»¥ä½¿ç”¨ annotate() æ­é… DRF çš„ ModelSerializerï¼š
```py
class UserViewSet(viewsets.ModelViewSet):
    queryset = User.objects.annotate(
        priority=Case(
            When(is_superuser=True, then=Value(1)),
            When(is_staff=True, then=Value(2)),
            default=Value(3),
            output_field=IntegerField()
        )
    )
    serializer_class = UserSerializer

âœ… ç„¶å¾Œåœ¨ Serializer ä¸­å®šç¾©è©²æ¬„ä½ï¼š

class UserSerializer(serializers.ModelSerializer):
    priority = serializers.IntegerField()

    class Meta:
        model = User
        fields = ['id', 'username', 'priority']
```
--- 



## ğŸ“˜ ä½¿ç”¨å ´æ™¯

- æ¬Šé‡æˆ–ç­‰ç´šåˆ¤æ–·èˆ‡æ’åºï¼ˆä¾‹å¦‚æœƒå“¡åˆ†ç´šï¼‰

- å°‡æŸäº›æ¢ä»¶è½‰ç‚ºç‰¹å®šé¡¯ç¤ºæ–‡å­—

- æ ¹æ“šæ¬„ä½å€¼æ”¹è®ŠæŸ¥è©¢é‚è¼¯æˆ–å›å‚³å…§å®¹

- æ‰¹é‡æ›´æ–°ï¼ˆupdate()ï¼‰æ™‚çš„æ¢ä»¶æŒ‡å®šï¼ˆF è¡¨é”å¼ + Caseï¼‰

--- 
## ğŸ›  å°æé†’
- `Case` èˆ‡ `When` é€šå¸¸æ­é… `annotate()` ä½¿ç”¨ä¾†æ–°å¢æ¬„ä½ï¼Œä¹Ÿå¯èˆ‡ `update()` æ­é…ç”¨ä¾†æ‰¹æ¬¡æ›´æ–°ã€‚
- `output_field` æ˜¯å¿…å¡«çš„ï¼Œå¿…é ˆæŒ‡å®šå›å‚³è³‡æ–™çš„é¡å‹ï¼ˆä¾‹å¦‚ `IntegerField`, `CharField`ï¼‰ã€‚
- `Value()` å…§çš„å€¼éœ€èˆ‡ `output_field` é¡å‹ç›¸ç¬¦ã€‚