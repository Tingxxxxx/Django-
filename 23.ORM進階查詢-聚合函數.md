# ORMæ¡†æ¶èšåˆå‡½æ•¸ç­†è¨˜

## 1. aggregate(): åƒ…è¿”å›èšåˆè¨ˆç®—å¾Œçš„çµæœ
âœ… **èªæ³•: `aggregate(è‡ªå®šç¾©key=èšåˆå‡½æ•¸('è¦çµ±è¨ˆçš„æ¬„ä½'))`**

- è¦å…ˆå°å…¥ç›¸é—œèšåˆå‡½æ•¸: 
    ```python
    from django.db.models import Avg,Count,Sum,Max,Min
    ```
- è¿”å›ä¸€å€‹å­—å…¸ï¼Œä¾‹å¦‚ï¼š`{"book_avg": 200}`ï¼Œå…¶ä¸­ï¼š
  - `book_avg` æ˜¯è‡ªè¨‚çš„ key åç¨±ã€‚
  - `200` æ˜¯å°æŒ‡å®šæ¬„ä½é€²è¡Œèšåˆè¨ˆç®—å¾Œçš„çµæœã€‚
- `aggregate()` **åªæœƒè¿”å›èšåˆçµæœï¼Œç„¡æ³•åŒæ™‚ç²å–æ¨¡å‹çš„å…¶ä»–æ¬„ä½**ï¼ˆä¾‹å¦‚ `name`ã€`age` ç­‰ï¼‰ã€‚
- `aggregate()` **ä½œç”¨æ–¼æ•´å€‹ QuerySet**ï¼Œè€Œéé€è¡Œè¨ˆç®—ã€‚  

### ç¯„ä¾‹:
```python
# æ¨¡å‹å®šç¾©
from django.db import models

class Author(models.Model):
    """ä½œè€…æ¨¡å‹"""
    name = models.CharField(max_length=100)
    age = models.IntegerField()
    email = models.EmailField()

    class Meta:
        db_table = 'front_author'

class Publisher(models.Model):
    """å‡ºç‰ˆç¤¾æ¨¡å‹"""
    name = models.CharField(max_length=300)

    class Meta:
        db_table = 'front_publisher'

class Book(models.Model):
    """åœ–æ›¸æ¨¡å‹"""
    name = models.CharField(max_length=300)
    pages = models.IntegerField()
    price = models.FloatField()
    rating = models.FloatField()
    author = models.ForeignKey(Author, on_delete=models.CASCADE)
    publisher = models.ForeignKey(Publisher, on_delete=models.CASCADE)

    class Meta:
        db_table = 'front_book'

class BookOrder(models.Model):
    """åœ–æ›¸è¨‚å–®æ¨¡å‹"""
    book = models.ForeignKey("Book", on_delete=models.CASCADE)
    price = models.FloatField()

    class Meta:
        db_table = 'front_book_order'

# æ¼”ç¤ºèšåˆå‡½æ•¸ä½¿ç”¨

# å…ˆå°å…¥èšåˆå‡½æ•¸
from django.db.models import Avg,Count,Sum,Max,Min
from django.http import JsonResponse

# ğŸ“Œ min æ‰¾å‡ºåƒ¹æ ¼æœ€ä½çš„æ›¸ç±
def min_view(request):
    # aggregate è¿”å›çµæœ:{'min_price': 42.5}ï¼Œå¯é€šéå­—å…¸æ“ä½œ[key]å–çš„å°æ‡‰çš„valueå€¼
    min_price = Book.objects.aggregate(min_price=Min('price'))['min_price']
    # query_set.values() å¯æŒ‡å®šè¦é¡¯ç¤ºé‚£äº›æ¬„ä½
    data = Book.objects.filter(price=min_price).values('id', 'name', 'price') 
    print(data)
    return JsonResponse(list(data), safe=False)

# ğŸ“Œ è¨ˆç®—æ‰€æœ‰æ›¸ç±çš„å¹³å‡åƒ¹æ ¼
def avg_book_price(request):
    avg_price = Book.objects.aggregate(avg_price=Avg('price'))['avg_price']
    return JsonResponse({'average_price': avg_price})
```

## 2. annotate(): é™„åŠ è¨ˆç®—çµæœ
âœ… **èªæ³•: annotate(è‡ªå®šç¾©key=èšåˆå‡½æ•¸('é—œè¯æ¨¡å‹æ¬„ä½'))**

- è¦å…ˆå°å…¥ç›¸é—œèšåˆå‡½æ•¸: 
    ```python
    from django.db.models import Avg,Count,Sum,Max,Min
    ```
- `annotate()` **è¿”å›çš„æ˜¯ä¸€å€‹ QuerySet**ï¼Œå¯ä»¥åƒä¸€èˆ¬çš„æŸ¥è©¢çµæœä¸€æ¨£ä½¿ç”¨ã€‚
- **å¯ä»¥åŒæ™‚ç²å–æ¨¡å‹çš„å…¶ä»–æ¬„ä½**ï¼Œä¸åƒ `aggregate()` åªèƒ½è¿”å›å–®ä¸€çµæœã€‚
- **å¯æ­é… `.values('æ¬„ä½å1', 'æ¬„ä½å2'...)`**ï¼ŒæŒ‡å®šè¦é¡¯ç¤ºçš„æ¬„ä½ã€‚
- **é©ç”¨æ–¼åˆ†çµ„è¨ˆç®—**ï¼Œ

### ç¯„ä¾‹:

```python
from django.http import JsonResponse
from django.db.models import Avg
from .models import Author, Book

# ğŸ“Œè¨ˆç®—æ¯ä½ä½œè€…çš„å¹³å‡æ›¸ç±åƒ¹æ ¼
def author_avg_price(request):
    # Avg('book__price'):èšåˆè¨ˆç®—bookæ¨¡å‹çš„priceæ¬„ä½
    data = Author.objects.annotate(avg_price=Avg('book__price')).values('id', 'name', 'avg_price')
    return JsonResponse(list(data), safe=False)

# ğŸ“Œ è¨ˆç®—æ¯æœ¬æ›¸çš„ç¸½éŠ·å”®é¡
def book_total_sales(request):
    data = Book.objects.annotate(total_sales=Sum('bookorder__price')).values('id', 'name', 'total_sales')
    return JsonResponse(list(data), safe=False)

# ğŸ“Œ è¨ˆç®—æ¯å®¶å‡ºç‰ˆç¤¾çš„ç¸½éŠ·å”®é‡‘é¡
def publisher_total_sales(request):
    # è§£æ: Sum('book__bookorder__price')
    # bookï¼šå¾ Publisher é€é Book æ¨¡å‹ï¼Œç²å–è©²å‡ºç‰ˆç¤¾æ‰€å‡ºç‰ˆçš„æ‰€æœ‰æ›¸ç±ã€‚
    # bookorderï¼šå¾ Book é€é BookOrder æ¨¡å‹ï¼Œç²å–é€™äº›æ›¸ç±çš„æ‰€æœ‰è¨‚å–®ã€‚
    # priceï¼šå¾ BookOrder å–å¾—è©²è¨‚å–®çš„åƒ¹æ ¼ã€‚
    data = Publisher.objects.annotate(total_sales=Sum('book__bookorder__price')).values('id', 'name', 'total_sales')
    return JsonResponse(list(data), safe=False)
```

## 3. å¸¸ç”¨èšåˆå‡½æ•¸

**1. Avg()**:ç”¨æ–¼è¨ˆç®—æŒ‡å®šæ¬„ä½çš„å¹³å‡å€¼ã€‚

**2. Count()**: ç”¨æ–¼è¨ˆç®—æŒ‡å®šæ¬„ä½æˆ–æ¢ç›®çš„æ•¸é‡ã€‚

**3. Sum()**: ç”¨æ–¼è¨ˆç®—æŒ‡å®šæ¬„ä½çš„ç¸½å’Œã€‚

**4. Max()**: ç”¨æ–¼è¨ˆç®—æŒ‡å®šæ¬„ä½çš„æœ€å¤§å€¼ã€‚

**5. Min()**: ç”¨æ–¼è¨ˆç®—æŒ‡å®šæ¬„ä½çš„æœ€å°å€¼ã€‚

