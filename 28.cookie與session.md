# ğŸª Cookie èˆ‡ ğŸ› ï¸ Session ç­†è¨˜

## 1ï¸âƒ£ Cookie æ˜¯ä»€éº¼ï¼Ÿ

âœ… **å®šç¾©**

**Cookie** æ˜¯ç”±ä¼ºæœå™¨è¨­å®šåœ¨ä½¿ç”¨è€…ç€è¦½å™¨ä¸­çš„å°å‹æ–‡å­—æª”æ¡ˆï¼Œç”¨ä¾†å­˜å„²ä½¿ç”¨è€…çš„è³‡è¨Šã€‚

ğŸ·ï¸ **ç‰¹é»**

- **å­˜å„²åœ¨ç€è¦½å™¨ç«¯**ï¼ˆClient-Sideï¼‰

- ç”± **ä¼ºæœå™¨ è¨­å®š**ï¼Œä¸¦åœ¨å¾ŒçºŒè«‹æ±‚ä¸­**è‡ªå‹•ç™¼é€å›ä¼ºæœå™¨**

- **å¤§å°é™åˆ¶**ï¼šæ¯å€‹ Cookie æœ€å¤šç´„ 4KB

- **ç”Ÿå‘½é€±æœŸ**ï¼šå¯è¨­å®š **Session Cookie**ï¼ˆç€è¦½å™¨é—œé–‰å³åˆªé™¤ï¼‰æˆ– **Persistent Cookie**ï¼ˆæ ¹æ“š Expires æˆ– Max-Age è¨­å®šéæœŸæ™‚é–“ï¼‰

- **å®‰å…¨æ€§è¼ƒä½**ï¼Œå®¹æ˜“è¢«ç«„æ”¹æˆ–åŠ«æŒ

ğŸ“Œ **Cookie ç”¨é€”**

- **ç”¨æˆ¶èº«ä»½è­˜åˆ¥**ï¼ˆå¦‚è‡ªå‹•ç™»å…¥ï¼‰

* **å„²å­˜ä½¿ç”¨è€…åå¥½**ï¼ˆå¦‚æ·±è‰²æ¨¡å¼ï¼‰

- **è¿½è¹¤ä½¿ç”¨è€…è¡Œç‚º**ï¼ˆå¦‚åˆ†æç”¨æˆ¶è¡Œç‚ºã€å»£å‘Šæ¨è–¦ï¼‰

---
## 2ï¸âƒ£ Session æ˜¯ä»€éº¼ï¼Ÿ

âœ… **å®šç¾©**

**Session**ï¼ˆæœƒè©±ï¼‰æ˜¯ä¸€ç¨®åœ¨ä¼ºæœå™¨ç«¯å„²å­˜ç”¨æˆ¶è³‡è¨Šçš„æ©Ÿåˆ¶ï¼Œæ¯å€‹ Session éƒ½æœ‰ä¸€å€‹å”¯ä¸€çš„ **Session ID**ï¼Œé€šå¸¸é€é Cookie å­˜æ”¾é€™å€‹ IDã€‚

ğŸ·ï¸ **ç‰¹é»**

- **å­˜å„²åœ¨ä¼ºæœå™¨ç«¯**ï¼ˆServer-Sideï¼‰

- **Session ID å­˜å„²æ–¼ Cookie**

- **Sessionæ•¸æ“šæœ¬èº«**åœ¨**Django**ä¸­é»˜èªå­˜æ–¼ä¼ºæœå™¨(server_side_ssion)

- **Flask æ¡†æ¶ä¸­** é è¨­ Session **åŠ å¯†** å¾Œå­˜æ–¼ Cookieä¸­(client_side_session)

- **å¤§å°ä¸å— Cookie é™åˆ¶**ï¼Œå¯ä»¥å­˜æ”¾è¼ƒå¤šè³‡è¨Š

- **å®‰å…¨æ€§è¼ƒé«˜**ï¼Œä½†ä»éœ€é˜²æ­¢ Session åŠ«æŒ

ğŸ“Œ **Session ç”¨é€”**

- **ç”¨æˆ¶èº«ä»½é©—è­‰**ï¼ˆç™»å…¥ç³»çµ±ï¼‰

- **å­˜å„²è³¼ç‰©è»Šè³‡è¨Š**ï¼ˆä¼ºæœå™¨ç«¯ç´€éŒ„ï¼‰

- **è·Ÿè¹¤ç”¨æˆ¶ç‹€æ…‹**ï¼ˆå¦‚åœ¨ç·šç”¨æˆ¶æ•¸ã€ç€è¦½æ­·å²ï¼‰


---
## 3ï¸âƒ£ Cookie çš„æ“ä½œæ–¹å¼

### 1. è¨­ç½® Cookie
åœ¨ Django ä¸­ï¼Œå¯ä»¥ä½¿ç”¨ `HttpResponse.set_cookie()` ä¾†è¨­ç½® Cookieã€‚

#### **èªæ³•**
```python
response.set_cookie(key, value, max_age=None, expires=None, path='/', domain=None, secure=False, httponly=False, samesite=None)
```

#### **ç¤ºä¾‹ï¼šè¨­ç½®ä¸€å€‹ Cookie**
```python
from django.http import HttpResponse

def set_cookie(request):
    response = HttpResponse("Cookie å·²è¨­ç½®ï¼")
    response.set_cookie('username', 'user123', max_age=3600)  # å­˜æ´»æ™‚é–“ 1 å°æ™‚
    return response
```

#### **å¸¸è¦‹åƒæ•¸**
- `key`ï¼šCookie çš„åç¨±ã€‚
- `value`ï¼šCookie çš„å€¼ã€‚
- `max_age`ï¼šå­˜æ´»æ™‚é–“ï¼ˆç§’ï¼‰ï¼Œä¾‹å¦‚ `3600` è¡¨ç¤º 1 å°æ™‚ã€‚
- `expires`ï¼šéæœŸæ™‚é–“ï¼ˆå…·é«”æ—¥æœŸï¼‰ï¼Œå¦‚ `datetime.datetime(2025, 1, 1)`ã€‚
- `path`ï¼šæŒ‡å®š Cookie é©ç”¨çš„ URL è·¯å¾‘ï¼ˆé è¨­ `/` ä»£è¡¨æ•´å€‹ç¶²ç«™ï¼‰ã€‚
- `domain`ï¼šæŒ‡å®šé©ç”¨çš„åŸŸåã€‚
- `secure`ï¼šè‹¥ç‚º `True`ï¼Œå‰‡åƒ…å…è¨± HTTPS å‚³è¼¸ã€‚
- `httponly`ï¼šè‹¥ç‚º `True`ï¼Œå‰‡ JavaScript ç„¡æ³•è®€å– Cookieã€‚
- `samesite`ï¼šå¯é¸ `'Strict'`ã€`'Lax'` æˆ– `'None'`ï¼Œç”¨æ–¼è·¨ç«™é»è«‹æ±‚æ§åˆ¶ã€‚

---
### 2. ç²å– Cookie
ä½¿ç”¨ `request.COOKIES.get(key, default=None)` ä¾†ç²å– Cookieã€‚

#### **ç¤ºä¾‹ï¼šç²å– Cookie**
```python
from django.http import HttpResponse

def get_cookie(request):
    # å¾ request ç‰©ä»¶ä¸­ç²å– cookie
    username = request.COOKIES.get('username', 'è¨ªå®¢')
    return HttpResponse(f'ç•¶å‰ç”¨æˆ¶åï¼š{username}')

# ä¹Ÿå¯å¾ªç’°éæ­·ï¼Œå¾—åˆ°æ‰€æœ‰cookieä¹Ÿå¯å¾ªç’°éæ­·ï¼Œå¾—åˆ°æ‰€æœ‰cookie
def get_cookie(request):
    # å¾ request ç‰©ä»¶ä¸­ç²å– cookie
    for key, value in request.COOKIES.items():
        print(key,value) 
        # å¯èƒ½è¼¸å‡ºä»¥ä¸‹å…©è¡Œ
        # sessionid r87a481rictiticen0rdy4w25hvrkrwas
        # username hellen
    return HttpResponse('ç²å– cookie')  # å›å‚³çµ¦ç”¨æˆ¶ç«¯

```

---
### 3. åˆªé™¤ Cookie
å¯ä»¥ä½¿ç”¨ `response.delete_cookie(key, path='/')` ä¾†åˆªé™¤ Cookieã€‚

#### **ç¤ºä¾‹ï¼šåˆªé™¤ Cookie**
```python
from django.http import HttpResponse

def delete_cookie(request):
    response = HttpResponse("Cookie å·²åˆªé™¤ï¼")
    response.delete_cookie('username')  # è¨˜å¾—å‚³è¦åˆªçš„cookie çš„ keyå€¼é€²å»
    return response
```

---
### 4. è¨­ç½® HttpOnly å’Œ Secure
ç‚ºäº†æé«˜å®‰å…¨æ€§ï¼Œå¯ä»¥è¨­ç½® `httponly=True` å’Œ `secure=True`ã€‚

#### **ç¤ºä¾‹ï¼šè¨­ç½®å®‰å…¨ Cookie**
```python
from django.http import HttpResponse

def set_secure_cookie(request):
    response = HttpResponse("å®‰å…¨ Cookie å·²è¨­ç½®ï¼")
    response.set_cookie('sessionid', 'abc123', httponly=True, secure=True)
    return response
```

---
### 5. ä½¿ç”¨ `samesite` é˜²æ­¢ CSRF æ”»æ“Š
`SameSite` å±¬æ€§å¯ä»¥é˜²æ­¢è·¨ç«™è«‹æ±‚å½é€ ï¼ˆCSRFï¼‰ã€‚ä¸”`SameSite=None` å¿…é ˆèˆ‡ `secure=True` é…åˆä½¿ç”¨

#### **ç¤ºä¾‹ï¼šè¨­ç½® SameSite å±¬æ€§**
```python
from django.http import HttpResponse

def set_samesite_cookie(request):
    response = HttpResponse("SameSite Cookie å·²è¨­ç½®ï¼")
    response.set_cookie('csrftoken', 'token123', samesite='Strict')
    return response
```

- `Strict`ï¼šå®Œå…¨ç¦æ­¢è·¨ç«™è«‹æ±‚æ”œå¸¶ Cookieã€‚
- `Lax`ï¼šå…è¨±éƒ¨åˆ†å®‰å…¨è«‹æ±‚ï¼ˆå¦‚ GET è«‹æ±‚ï¼‰æ”œå¸¶ Cookieã€‚
- `None`ï¼šå…è¨±è·¨ç«™è«‹æ±‚æ”œå¸¶ Cookieï¼ˆéœ€æ­é… `secure=True`ï¼‰ã€‚

---
### 6. åœ¨ Django è¨­å®šå…¨åŸŸæ€§ Cookie å±¬æ€§
å¯åœ¨ `settings.py` ä¸­å…¨åŸŸæ€§è¨­ç½® Cookie ç›¸é—œçš„å®‰å…¨å±¬æ€§ã€‚

```python
# è¨­ç½® Cookie çš„å®‰å…¨å±¬æ€§
SESSION_COOKIE_SECURE = True    # åªå…è¨± HTTPS å‚³è¼¸
SESSION_COOKIE_HTTPONLY = True  # ç¦æ­¢ JavaScript å­˜å–
SESSION_COOKIE_SAMESITE = 'Lax' # é è¨­ç‚º Laxï¼Œé˜²æ­¢ CSRF
CSRF_COOKIE_SECURE = True       # ç¢ºä¿ CSRF Token åªèƒ½é€é HTTPS å‚³è¼¸
CSRF_COOKIE_HTTPONLY = True     # ç¦æ­¢ JavaScript å­˜å– CSRF Token
CSRF_COOKIE_SAMESITE = 'Strict' # CSRF Token ä¸å…è¨±è·¨ç«™æ”œå¸¶
```



---
### 7. ç¸½çµ
1. ä½¿ç”¨ `response.set_cookie()` è¨­ç½® Cookieï¼Œå¯é…ç½® `max_age`ã€`httponly`ã€`secure` ç­‰é¸é …ã€‚
2. ä½¿ç”¨ `request.COOKIES.get()` ç²å– Cookieï¼Œè‹¥ Cookie ä¸å­˜åœ¨å‰‡è¿”å› `None`ã€‚
3. ä½¿ç”¨ `response.delete_cookie()` åˆªé™¤ Cookieã€‚
4. ä½¿ç”¨ `request.COOKIES.items()` ä¸¦å¾ªç’°éæ­·ï¼Œå¯ä»¥å–å‡ºæ‰€æœ‰cookie
5. è¨­ç½® `HttpOnly` å’Œ `Secure` å±¬æ€§å¯æé«˜å®‰å…¨æ€§ã€‚
6. `SameSite` å±¬æ€§å¯é˜²æ­¢ CSRF æ”»æ“Šï¼Œæ¨è–¦è¨­ç½®ç‚º `Lax` æˆ– `Strict`ã€‚
7. Django Session æ¯”ç›´æ¥ä½¿ç”¨ Cookie æ›´å®‰å…¨ï¼Œé©åˆå­˜å„²é‡è¦æ•¸æ“šã€‚

---
## 4ï¸âƒ£ Session çš„æ“ä½œæ–¹å¼

### 1. è¨­ç½® Session
åœ¨ Django ä¸­ï¼Œå¯ä»¥ä½¿ç”¨ request.session ä¾†è¨­ç½® Sessionã€‚ä¸”è¨­ç½® session æ™‚ï¼ŒDjango æœƒè‡ªå‹•ç”Ÿæˆä¸€å€‹ sessionidï¼Œä¸¦å°‡å…¶å„²å­˜æ–¼ç”¨æˆ¶ç«¯çš„ Cookie ä¸­


#### èªæ³•
```python
request.session['key'] = 'value'
request.session.set_expiry(value)
```

#### ç¤ºä¾‹ï¼šè¨­ç½®ä¸€å€‹ Session
```python
from django.http import HttpResponse

# è¨­ç½® session å¾Œ Django æœƒè‡ªå‹•ç”Ÿæˆä¸€å€‹sessionidä¸¦å‚³çµ¦ç€è¦½å™¨
def set_session(request):
    request.session['username'] = 'user123'  # å­˜å…¥ session
    request.session.set_expiry(3600)  # æŒ‡å®š session æœ‰æ•ˆæœŸç‚º 1 å°æ™‚
    return HttpResponse("Session å·²è¨­ç½®ï¼")
```

#### å¸¸è¦‹åƒæ•¸
- `key`ï¼šSession çš„åç¨±ã€‚
- `value`ï¼šSession çš„å€¼ã€‚
- `set_expiry(value)`ï¼šè¨­ç½® Session æœ‰æ•ˆæœŸï¼Œè‹¥ `value` ç‚ºï¼š
  - `0`ï¼šç€è¦½å™¨é—œé–‰å°±åˆªé™¤ Sessionã€‚
  - `None`ï¼šä½¿ç”¨ Django é è¨­çš„ SESSION_COOKIE_AGEã€‚
  - `N`ï¼šè¨­å®š N ç§’å¾Œåˆ°æœŸã€‚


---
### 2. å–å¾— Session
ä½¿ç”¨ `request.session.get(key, default=None)` ä¾†å–å¾— Sessionã€‚

ç¤ºä¾‹ï¼šå–å¾— Session
```python
from django.http import HttpResponse

def get_session(request):
    username = request.session.get('username', 'è¨ªå®¢')  # é è¨­å€¼ç‚º "è¨ªå®¢"
    return HttpResponse(f'ç•¶å‰ç”¨æˆ¶åï¼š{username}')
```

---
### 3. åˆªé™¤ Session
å¯ä»¥ä½¿ç”¨ `request.session.flush()` æˆ– `del request.session[key]` ä¾†åˆªé™¤ Sessionã€‚

#### ç¤ºä¾‹ï¼šåˆªé™¤ Session
```python
from django.http import HttpResponse

def delete_session(request):
    request.session.flush()  # æ¸…ç©ºæ‰€æœ‰ session æ•¸æ“š
    return HttpResponse("Session å·²åˆªé™¤ï¼")
```

---
### 4. åˆªé™¤ session ä¸­çš„æŸå€‹éµ
å¯ä»¥ä½¿ç”¨ session.pop(key, default) æ–¹æ³•ä¾†åˆªé™¤æŸå€‹æŒ‡å®šçš„éµï¼Œä¸¦è¿”å›è©²éµçš„å€¼ã€‚å¦‚æœè©²éµä¸å­˜åœ¨ï¼Œå‰‡è¿”å› defaultï¼ˆå¦‚æœæä¾›çš„è©±ï¼‰ã€‚

#### ç¤ºä¾‹ï¼šåˆªé™¤ Session ä¸­æŒ‡å®šçš„éµå€¼
```python
from django.http import HttpResponse

def remove_session_key(request):
    username = request.session.pop('username', 'è¨ªå®¢')
    return HttpResponse(f'å·²ç§»é™¤ session éµï¼ŒåŸå€¼ç‚ºï¼š{username}')
```

---
### 5. è¨­ç½® Session å„²å­˜çš„å½¢å¼
Django é è¨­å°‡ Session å­˜åœ¨ **è³‡æ–™åº«**ï¼Œå¯ä»¥åœ¨ `settings.py` ä¿®æ”¹ `SESSION_ENGINE` ä¾†è¨­å®šå­˜å‚¨æ–¹å¼ã€‚

#### ä¸»è¦é¸é …ï¼š
```python
SESSION_ENGINE = 'django.contrib.sessions.backends.db'  # é è¨­ï¼Œå­˜å…¥è³‡æ–™åº«
SESSION_ENGINE = 'django.contrib.sessions.backends.cache'  # ä½¿ç”¨å¿«å–
SESSION_ENGINE = 'django.contrib.sessions.backends.cached_db'  # å¿«å–+è³‡æ–™åº«
SESSION_ENGINE = 'django.contrib.sessions.backends.file'  # å­˜å…¥æª”æ¡ˆ
SESSION_ENGINE = 'django.contrib.sessions.backends.signed_cookies'  # ä»¥ Cookie æ–¹å¼å„²å­˜
```

---
### 5. ç¸½çµ
- ä½¿ç”¨ `request.session['key'] = value` è¨­ç½® Sessionã€‚
- ä½¿ç”¨ `request.session.get(key, default=None)` å–å¾— Sessionã€‚
- ä½¿ç”¨ `request.session.flush()` æˆ– `del request.session[key]` åˆªé™¤ Sessionã€‚
- ä½¿ç”¨  `request.session.pop(key, default)` ä¾†åˆªé™¤ session ä¸­çš„æŸå€‹éµã€‚
- `SESSION_ENGINE` å¯ä»¥è¨­å®š Session å„²å­˜æ–¹å¼ï¼Œæ¨è–¦ä½¿ç”¨è³‡æ–™åº«æˆ–è€…å¿«å–ã€‚
- Session æ¯” Cookie æ›´å®‰å…¨ï¼Œé©åˆå­˜å‚¨é‡è¦è³‡æ–™ã€‚

---
### 6. Cookie å’Œ Django Session çš„å€åˆ¥
| ç‰¹æ€§     | Cookie                  | Django Session            |
|----------|-------------------------|---------------------------|
| å„²å­˜ä½ç½® | å®¢æˆ¶ç«¯ï¼ˆç€è¦½å™¨ï¼‰     ã€€   | ä¼ºæœå™¨ç«¯ï¼ˆé»˜èªå­˜æ–¼è³‡æ–™åº«ï¼‰ |
| å®‰å…¨æ€§   | æ˜“å—æ”»æ“Šï¼ˆå¯è¢«ä¿®æ”¹ï¼‰  ã€€ã€€| ç›¸å°æ›´å®‰å…¨ï¼ˆå­˜å„²åœ¨ä¼ºæœå™¨ï¼‰ |
| å­˜å„²å¤§å° | å—é™æ–¼ç€è¦½å™¨ï¼ˆä¸€èˆ¬ 4KBï¼‰ã€€| å¯å­˜æ›´å¤§æ•¸æ“š              |
| é©ç”¨å ´æ™¯ | å„²å­˜å°é‡æ•¸æ“šï¼Œå¦‚ç”¨æˆ¶åå¥½  | å„²å­˜ç”¨æˆ¶ç™»å…¥ç‹€æ…‹ç­‰é‡è¦ä¿¡æ¯ |


